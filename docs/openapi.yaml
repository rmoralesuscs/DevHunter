openapi: 3.0.3
info:
  title: Dev Hunter Ingest & Search API
  version: 1.0.0
  description: |
    OpenAPI spec for async ingest, operations, search, presign/finalize flows.
    - Async ingest returns 202 with an `Operation` resource (see /operations/{id}).
    - Presign/finalize support multiple cloud providers. MP4 uploads are behind a feature flag.
    - Phase-2: auth placeholders are present but not enforced in this version.
servers:
  - url: https://api.example.com/v1
paths:
  /ingest:
    post:
      summary: Start async ingest (upload via presigned URL)
      operationId: startIngest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IngestRequest'
            examples:
              ingest-json:
                summary: Minimal ingest request
                value:
                  test_id: "test-123"
                  metadata:
                    name: "Smoke Test"
                  artifact:
                    filename: "results.json"
                    content_type: "application/json"
                    size_bytes: 1234
      responses:
        '202':
          description: Accepted — operation started
          headers:
            Location:
              description: URL to poll for operation status
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Operation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          $ref: '#/components/responses/RequestEntityTooLarge'
        '415':
          $ref: '#/components/responses/UnsupportedMediaType'
  /operations/{operationId}:
    get:
      summary: Fetch operation status
      operationId: getOperation
      parameters:
        - name: operationId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Operation resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Operation'
        '404':
          $ref: '#/components/responses/NotFound'
  /search:
    get:
      summary: Full-text search over tests and runs
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
          description: Query expression (plain text)
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Search results with ranking
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResults'
  /artifacts/presign:
    post:
      summary: Request presigned URL for artifact upload
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PresignRequest'
            examples:
              presign:
                value:
                  filename: "results.zip"
                  content_type: "application/zip"
                  size_bytes: 102400
      responses:
        '200':
          description: Presigned upload information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          $ref: '#/components/responses/RequestEntityTooLarge'
  /artifacts/finalize:
    post:
      summary: Finalize uploaded artifact (checksum verification & persistence)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FinalizeRequest'
            examples:
              finalize:
                value:
                  presigned_id: "abc-123"
                  size_bytes: 102400
                  sha256: "<hex-sha256>"
      responses:
        '200':
          description: Finalization successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artifact'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Checksum mismatch or size mismatch
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
components:
  schemas:
    IngestRequest:
      type: object
      required: [test_id, artifact]
      properties:
        test_id:
          type: string
        metadata:
          type: object
          additionalProperties: true
        artifact:
          type: object
          required: [filename, content_type, size_bytes]
          properties:
            filename:
              type: string
            content_type:
              type: string
            size_bytes:
              type: integer
    Operation:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
          enum: [PENDING, RUNNING, SUCCEEDED, FAILED]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        warnings:
          type: array
          items:
            type: object
            properties:
              code:
                type: string
              message:
                type: string
        result:
          type: object
          nullable: true
    PresignRequest:
      type: object
      properties:
        filename:
          type: string
        content_type:
          type: string
        size_bytes:
          type: integer
    PresignResponse:
      type: object
      properties:
        provider:
          type: string
          description: Storage provider used (azure|aws|gcs)
        upload_url:
          type: string
        fields:
          type: object
          additionalProperties: true
        expires_in_seconds:
          type: integer
    FinalizeRequest:
      type: object
      properties:
        presigned_id:
          type: string
        size_bytes:
          type: integer
        sha256:
          type: string
    Artifact:
      type: object
      properties:
        id:
          type: string
        url:
          type: string
        size_bytes:
          type: integer
        sha256:
          type: string
    SearchResults:
      type: object
      properties:
        total:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              type:
                type: string
              score:
                type: number
              snippet:
                type: string
    Problem:
      type: object
      required: [type, title]
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
        errors:
          type: array
          items:
            type: object
            additionalProperties: true
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          examples:
            missing-field:
              value:
                type: "https://api.example.com/probs/invalid-request"
                title: "Invalid request"
                status: 400
                detail: "artifact.size_bytes is required"
    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
    RequestEntityTooLarge:
      description: Payload too large
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          examples:
            too-large:
              value:
                type: "https://api.example.com/probs/too-large"
                title: "Payload too large"
                status: 413
                detail: "Max allowed size is 200MB unless feature-flag permits mp4 uploads"
    UnsupportedMediaType:
      description: Unsupported MIME type
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/Problem'
          examples:
            unsupported-mime:
              value:
                type: "https://api.example.com/probs/unsupported-media-type"
                title: "Unsupported media type"
                status: 415
                detail: "Allowed MIME types: application/json, application/octet-stream, application/zip, image/png, image/jpeg, audio/* — mp4 uploads are behind feature-flag"
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "Phase‑2 placeholder: OAuth2/JWT will be defined in Phase 2. Not enforced in this spec version."
components:
  # (note: duplicated key above is intentional in YAML but some linters prefer merged components; keep concise)
  examples: {}
x-guidelines:
  size_limits:
    default_max_bytes: 209715200 # 200MB
    mp4_feature_flag: FEATURE_FLAG_ENABLE_MP4_UPLOADS
    mp4_max_bytes: 524288000 # 500MB
  allowed_mime_types:
    - application/json
    - application/octet-stream
    - application/zip
    - image/png
    - image/jpeg
    - audio/*
    - video/mp4 # allowed only when feature flag is enabled
  idempotency:
    header: Idempotency-Key
    ttl_seconds: 86400
  notes:
    - Problem+JSON is used for error responses (application/problem+json)
    - ETag support: controllers should return ETag and enforce 412 on stale updates
    - CORS: allow origins configured by environment

